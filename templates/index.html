<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lector de Textos IA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { 
            background-color: #f0f2f5; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container { 
            padding: 20px;
            margin-top: 20px;
        }
        .card {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 8px;
            border: none;
        }
        .control-card {
            background-color: #fff;
            padding: 1.2rem;
            height: 100%;
        }
        .text-area {
            height: 500px;
            font-size: 1.1rem;
            line-height: 1.8;
            border-color: #dee2e6;
            border-radius: 6px;
        }
        .highlight-container {
            background-color: #fff;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-top: 20px;
        }
        .read-highlight {
            font-size: 1.1rem;
            line-height: 1.8;
            padding: 1rem;
        }
        .control-btn {
            padding: 0.5rem 1rem;
        }
        .title-bar {
            background: linear-gradient(90deg, #4e54c8, #8f94fb);
            padding: 1rem;
            color: white;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
<div class="container-fluid main-container">
    <div class="row">
        <div class="col-12">
            <div class="title-bar">
                <h2 class="mb-0">Lector de Textos con IA Avanzada</h2>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12 col-lg-3">
            <div class="card control-card mb-4">
                <h4 class="mb-3 border-bottom pb-2">Control de Lectura</h4>
                <div id="audioContainer" class="w-100 mb-3"></div>
                <div class="d-flex justify-content-between align-items-center w-100 mb-3">
                    <div class="d-flex flex-wrap">
                        <button id="pauseBtn" class="btn btn-outline-primary control-btn">
                            <i class="bi bi-pause-fill"></i> Pausar
                        </button>
                        <button id="resumeBtn" class="btn btn-outline-primary control-btn ms-2" style="display:none;">
                            <i class="bi bi-play-fill"></i> Reanudar
                        </button>
                    </div>
                </div>
                <div class="d-flex justify-content-between align-items-center w-100">
                    <button id="cancelBtn" class="btn btn-danger control-btn">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button id="exportBtn" class="btn btn-success control-btn">
                        <i class="bi bi-download"></i> Exportar
                    </button>
                </div>
            </div>
        </div>
        
        <div class="col-12 col-lg-9">
            <div class="card">
                <div class="card-body">
                    <form id="textForm">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <label for="textInput" class="form-label fs-5">Texto a leer</label>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-play-circle"></i> Reproducir
                                </button>
                            </div>
                            <textarea class="form-control text-area" id="textInput" placeholder="Pega tu texto aquÃ­..."></textarea>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="highlight-container">
                <h5 class="mb-3 border-bottom pb-2">Seguimiento de lectura</h5>
                <div id="readingHighlight" class="read-highlight"></div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<script>
const form = document.getElementById('textForm');
const textInput = document.getElementById('textInput');
const audioContainer = document.getElementById('audioContainer');
let cancelRequested = false;
const cancelBtn = document.getElementById('cancelBtn');
const exportBtn = document.getElementById('exportBtn');
const pauseBtn = document.getElementById('pauseBtn');
const resumeBtn = document.getElementById('resumeBtn');
let isPaused = false;
let audioElem = null;

cancelBtn.onclick = async () => {
    cancelRequested = true;
    audioContainer.innerHTML = '<div class="text-secondary">Lectura cancelada.</div>';
    await fetch('/clear_cache', { method: 'POST' });
};

exportBtn.onclick = async () => {
    exportBtn.disabled = true;
    const originalText = exportBtn.innerHTML;
    exportBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Exportando...`;
    const res = await fetch('/export_all', { method: 'POST' });
    const data = await res.json();
    exportBtn.disabled = false;
    exportBtn.innerHTML = originalText;
    if (data.export_url) {
        const a = document.createElement('a');
        a.href = data.export_url;
        a.download = 'lectura_completa.mp3';
        a.click();
    }
};

pauseBtn.onclick = () => {
    if (audioElem && !audioElem.paused) {
        audioElem.pause();
        isPaused = true;
        pauseBtn.style.display = 'none';
        resumeBtn.style.display = '';
    }
};

resumeBtn.onclick = () => {
    if (audioElem && isPaused) {
        audioElem.play();
        isPaused = false;
        pauseBtn.style.display = '';
        resumeBtn.style.display = 'none';
    }
};

let current = 0;
let audios = [];
let partSpans = [];

function highlightPart(idx) {
    if (!partSpans.length) return;
    partSpans.forEach((span, i) => {
        span.style.background = i === idx ? '#ffe066' : '';
    });
}

form.onsubmit = async (e) => {
    e.preventDefault();
    cancelRequested = false;
    isPaused = false;
    pauseBtn.style.display = '';
    resumeBtn.style.display = 'none';
    audioContainer.innerHTML = '';
    document.getElementById('readingHighlight').innerHTML = '';
    await fetch('/clear_cache', { method: 'POST' });
    const text = textInput.value;
    // Divide el texto en partes para resaltar
    const splitRes = await fetch('/split', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text })
    });
    const splitData = await splitRes.json();
    const parts = splitData.parts;
    // Renderiza el texto con spans para resaltar
    const highlightDiv = document.getElementById('readingHighlight');
    highlightDiv.innerHTML = '';
    partSpans = parts.map((part, i) => {
        const span = document.createElement('span');
        span.textContent = part + ' ';
        span.style.transition = 'background 0.3s';
        highlightDiv.appendChild(span);
        return span;
    });
    // Solicita las URLs de audio por partes
    const res = await fetch('/tts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text })
    });
    const data = await res.json();
    current = 0;
    audios = data.audio_urls;
    audioElem = document.getElementById('mainAudio');
    if (!audioElem) {
        audioElem = document.createElement('audio');
        audioElem.id = 'mainAudio';
        audioElem.controls = true;
        audioElem.style.width = '100%';
        audioContainer.appendChild(audioElem);
    }
    async function waitForAudio(url) {
        for (let i = 0; i < 60; i++) { // espera hasta 30 segundos
            if (cancelRequested) return false;
            const resp = await fetch(url, { method: 'HEAD' });
            if (resp.ok) return true;
            await new Promise(r => setTimeout(r, 500));
        }
        return false;
    }
    async function playNext() {
        if (cancelRequested) return;
        if (current < audios.length) {
            highlightPart(current);
            audioContainer.insertAdjacentHTML('beforeend', `<div id='loadingMsg' class='text-secondary'>Cargando parte ${current+1}...</div>`);
            const url = audios[current];
            const ready = await waitForAudio(url);
            document.getElementById('loadingMsg')?.remove();
            if (ready) {
                audioElem.src = url;
                audioElem.play();
            } else {
                audioContainer.insertAdjacentHTML('beforeend', `<div class='text-danger'>No se pudo cargar el audio.</div>`);
            }
        } else {
            highlightPart(-1);
        }
    }
    audioElem.onended = async () => {
        if (isPaused) return;
        // Borra el audio anterior del servidor
        if (current < audios.length) {
            await fetch('/delete_audio', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: audios[current] })
            });
        }
        current++;
        playNext();
    };
    playNext();
};
</script>
</body>
</html>
