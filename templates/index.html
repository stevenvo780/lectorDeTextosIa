<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lector de Textos IA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { 
            background-color: #f0f2f5; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container { 
            padding: 20px;
            margin-top: 20px;
        }
        .card {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 8px;
            border: none;
        }
        .control-card {
            background-color: #fff;
            padding: 1.2rem;
            height: 100%;
        }
        .text-container {
            position: relative;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            min-height: 600px;
            margin-bottom: 1rem;
            background: #fff;
            height: 60vh;
            overflow: auto;
        }
        .text-area {
            width: 100%;
            height: 100%;
            min-height: 600px;
            font-size: 1.1rem;
            line-height: 1.8;
            border: none;
            background: transparent;
            padding: 1rem;
            font-family: inherit;
            white-space: pre-wrap;
            resize: none;
            position: relative;
            z-index: 1;
            box-sizing: border-box;
        }
        .text-area:focus {
            outline: none;
            box-shadow: none;
        }
        .highlight-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 1rem;
            font-size: 1.1rem;
            line-height: 1.8;
            pointer-events: none;
            white-space: pre-wrap;
            overflow: hidden;
            z-index: 2;
            color: transparent; /* hide non-highlighted overlay text */
        }
        .highlight {
            background-color: #ffe066; /* Light yellow highlight */
            border-radius: 3px;
            display: inline;
            color: #000; /* ensure highlighted text is visible */
        }
        .highlight-overlay .highlight {
            color: #000;
            background-color: #ffe066; /* Light yellow highlight */
        }
        .control-btn {
            padding: 0.5rem 1rem;
        }
        .title-bar {
            background: linear-gradient(90deg, #4e54c8, #8f94fb);
            padding: 1rem;
            color: white;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        .shortcut-info {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 0.5rem;
        }
        #pdfStatus {
            font-size: 0.9rem;
        }
        .keyboard-shortcut {
            background: #e9ecef;
            border-radius: 3px;
            padding: 0.2rem 0.4rem;
            margin: 0 0.2rem;
        }
        .status-bar {
            font-size: 0.9rem;
            margin-top: 0.5rem;
            padding: 0.5rem 0;
        }
    </style>
</head>
<body>
<div class="container-fluid main-container">
    <div class="row">
        <div class="col-12">
            <div class="title-bar">
                <h2 class="mb-0">Lector de Textos con IA Avanzada</h2>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12 col-lg-3">
            <div class="card control-card mb-4">
                <h4 class="mb-3 border-bottom pb-2">Control de Lectura</h4>
                <div id="audioContainer" class="w-100 mb-3"></div>
                <div class="d-flex justify-content-between align-items-center w-100 mb-3">
                    <button id="pauseBtn" class="btn btn-outline-primary control-btn">
                        <i class="bi bi-pause-fill"></i> Pausar
                    </button>
                    <button id="resumeBtn" class="btn btn-outline-primary control-btn" style="display:none;">
                        <i class="bi bi-play-fill"></i> Reanudar
                    </button>
                    <button id="cancelBtn" class="btn btn-danger control-btn">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                </div>
                <!-- Botones para párrafo anterior/siguiente -->
                <div class="d-flex justify-content-between align-items-center w-100 mb-3">
                    <button id="prevBtn" class="btn btn-outline-primary control-btn">
                        <i class="bi bi-skip-start-fill"></i> Anterior
                    </button>
                    <button id="nextBtn" class="btn btn-outline-primary control-btn">
                        <i class="bi bi-skip-end-fill"></i> Siguiente
                    </button>
                </div>
                <div class="d-flex justify-content-between align-items-center w-100 mb-3">
                    <!-- Duplicate prev/next removed -->
                </div>
                <div class="d-flex justify-content-center w-100 mt-3">
                    <button id="exportBtn" class="btn btn-success control-btn w-100">
                        <i class="bi bi-download"></i> Exportar Audio MP3
                    </button>
                </div>
                
                <div class="shortcut-info mt-4">
                    <h6>Atajos de teclado:</h6>
                    <ul class="ps-3 mb-0">
                        <li><span class="keyboard-shortcut">Espacio</span> - Pausar/Reanudar</li>
                        <li><span class="keyboard-shortcut">←</span><span class="keyboard-shortcut">→</span> - Anterior/Siguiente párrafo</li>
                        <li><span class="keyboard-shortcut">Ctrl</span>+<span class="keyboard-shortcut">Enter</span> - Leer párrafo actual</li>
                    </ul>
                </div>
                
                <div class="status-bar border-top mt-3 pt-2" id="statusBar">
                    Listo para comenzar la lectura
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-body">
                    <form id="pdfForm" enctype="multipart/form-data">
                        <label for="pdfInput" class="form-label">Cargar PDF</label>
                        <input type="file" class="form-control" id="pdfInput" accept="application/pdf">
                    </form>
                    <div id="pdfStatus" class="text-secondary mt-2"></div>
                </div>
            </div>
        </div>
        
        <div class="col-12 col-lg-9">
            <div class="card">
                <div class="card-body">
                    <form id="textForm">
                        <div class="mb-3">
                            <label for="textInput" class="form-label fs-5 mb-2">Texto a leer</label>
                            <div class="text-container" style="min-height: 600px; height: 60vh;">
                                <textarea class="form-control text-area" id="textInput" placeholder="Pega tu texto aquí..." style="min-height: 600px; height: 60vh;"></textarea>
                                <div id="highlightOverlay" class="highlight-overlay"></div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end mb-3">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-play-circle"></i> Reproducir
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<script>
const form = document.getElementById('textForm');
const textInput = document.getElementById('textInput');
const highlightOverlay = document.getElementById('highlightOverlay');
const audioContainer = document.getElementById('audioContainer');
const statusBar = document.getElementById('statusBar');
const cancelBtn = document.getElementById('cancelBtn');
const exportBtn = document.getElementById('exportBtn');
const pauseBtn = document.getElementById('pauseBtn');
const resumeBtn = document.getElementById('resumeBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');

let cancelRequested = false;
let isPaused = false;
let audioElem = null;
let current = 0;
let audios = [];
let textParts = [];

// Sincroniza el scroll entre el textarea y la capa de resaltado
textInput.addEventListener('scroll', () => {
    highlightOverlay.scrollTop = textInput.scrollTop;
});

/**
 * Muestra un mensaje de error temporal
 */
function showError(msg) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-danger alert-dismissible fade show position-fixed';
    alert.role = 'alert';
    alert.style = 'bottom: 20px; right: 20px; max-width: 400px; z-index: 9999;';
    alert.innerHTML = msg + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
    document.body.appendChild(alert);
    setTimeout(() => alert.remove(), 6000);
}

/**
 * Actualiza el estado mostrado en la barra de estado
 */
function updateStatus(message) {
    statusBar.textContent = message;
}

/**
 * Divide el texto en párrafos basados en saltos dobles o títulos markdown
 */
function getPartsFromText(text) {
    // Divide por saltos dobles de línea o por líneas vacías (mejor para textos pegados de Word/Google Docs)
    let raw = text.split(/(?:\r?\n){2,}/g);
    // Si hay líneas muy largas, las parte en frases de hasta 500 caracteres para evitar audios demasiado largos
    let parts = [];
    for (let p of raw) {
        let trimmed = p.trim();
        if (!trimmed) continue;
        if (trimmed.length > 500) {
            // Parte en frases por punto seguido
            let sentences = trimmed.match(/[^.!?\n]+[.!?\n]+/g) || [trimmed];
            let buffer = '';
            for (let s of sentences) {
                if ((buffer + s).length > 500) {
                    parts.push(buffer.trim());
                    buffer = '';
                }
                buffer += s;
            }
            if (buffer.trim()) parts.push(buffer.trim());
        } else {
            parts.push(trimmed);
        }
    }
    return parts;
}

/**
 * Resalta un párrafo específico en el texto
 */
function highlightParagraph(paragraphIndex) {
    if (!textParts.length || paragraphIndex >= textParts.length) return;
    
    const fullText = textInput.value;
    const partToHighlight = textParts[paragraphIndex];
    
    // Encuentra la posición del párrafo en el texto completo
    const startPos = fullText.indexOf(partToHighlight);
    if (startPos === -1) return;
    
    // Crea el HTML con la parte resaltada
    const beforeText = fullText.substring(0, startPos);
    const highlightedPart = partToHighlight;
    const afterText = fullText.substring(startPos + highlightedPart.length);
    
    highlightOverlay.innerHTML = '';
    
    // Parte anterior al resaltado
    if (beforeText) {
        const beforeSpan = document.createElement('span');
        beforeSpan.textContent = beforeText;
        highlightOverlay.appendChild(beforeSpan);
    }
    
    // Parte resaltada
    const highlightSpan = document.createElement('span');
    highlightSpan.className = 'highlight';
    highlightSpan.textContent = highlightedPart;
    highlightOverlay.appendChild(highlightSpan);
    
    // Parte posterior al resaltado
    if (afterText) {
        const afterSpan = document.createElement('span');
        afterSpan.textContent = afterText;
        highlightOverlay.appendChild(afterSpan);
    }
    
    // Hace scroll automático a la parte resaltada si está fuera de la vista
    const textAreaHeight = textInput.clientHeight;
    const lineHeight = parseInt(window.getComputedStyle(textInput).lineHeight);
    const linesInView = Math.floor(textAreaHeight / lineHeight);
    
    // Calcula la posición aproximada de línea para el texto resaltado
    const beforeLines = beforeText.split('\n').length;
    const highlightedLines = highlightedPart.split('\n').length;
    
    // Si el párrafo resaltado está fuera de la vista, hacer scroll
    const currentScrollPos = textInput.scrollTop / lineHeight;
    if (beforeLines < currentScrollPos || beforeLines + highlightedLines > currentScrollPos + linesInView) {
        // Ajusta el scroll para mostrar el párrafo resaltado
        textInput.scrollTop = lineHeight * (beforeLines - 2); // -2 para dar algo de margen superior
    }
    
    updateStatus(`Reproduciendo parte ${paragraphIndex + 1} de ${textParts.length}`);
}

/**
 * Limpia el resaltado
 */
function clearHighlight() {
    highlightOverlay.innerHTML = '';
}

/**
 * Salta a un párrafo específico y lo reproduce
 */
function jumpToPart(idx) {
    if (idx >= 0 && idx < textParts.length && audios.length && idx < audios.length) {
        current = idx;
        if (audioElem) audioElem.pause();
        playNext();
    }
}

// Manejadores de eventos para los botones de control
cancelBtn.onclick = async () => {
    cancelRequested = true;
    clearHighlight();
    audioContainer.innerHTML = '';
    if (audioElem) audioElem.pause();
    updateStatus('Lectura cancelada');
    textInput.readOnly = false;
    await fetch('/clear_cache', { method: 'POST' });
};

exportBtn.onclick = async () => {
    exportBtn.disabled = true;
    const originalText = exportBtn.innerHTML;
    exportBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Exportando...`;
    updateStatus('Exportando audio...');
    
    const res = await fetch('/export_all', { method: 'POST' });
    const data = await res.json();
    
    exportBtn.disabled = false;
    exportBtn.innerHTML = originalText;
    
    if (data.export_url) {
        const a = document.createElement('a');
        a.href = data.export_url;
        a.download = 'lectura_completa.mp3';
        a.click();
        updateStatus('Audio exportado con éxito');
    } else {
        updateStatus('Error al exportar el audio');
        showError('No se pudo exportar el audio.');
    }
};

pauseBtn.onclick = () => {
    if (audioElem && !audioElem.paused) {
        audioElem.pause();
        isPaused = true;
        pauseBtn.style.display = 'none';
        resumeBtn.style.display = '';
        updateStatus('Reproducción pausada');
    }
};

resumeBtn.onclick = () => {
    if (audioElem && isPaused) {
        audioElem.play();
        isPaused = false;
        pauseBtn.style.display = '';
        resumeBtn.style.display = 'none';
        updateStatus(`Reproduciendo parte ${current + 1} de ${textParts.length}`);
    }
};

// Atajos de teclado para la aplicación
document.addEventListener('keydown', function(e) {
    // No capturar los atajos cuando está escribiendo en el textarea
    if (e.target === textInput && e.code !== 'Enter') return;
    
    if (e.code === 'Space') {
        e.preventDefault();
        if (audioElem && !audioElem.paused) {
            pauseBtn.click();
        } else if (audioElem && isPaused) {
            resumeBtn.click();
        }
    } else if (e.code === 'ArrowRight') {
        e.preventDefault();
        if (current < audios.length - 1) {
            current++;
            playNext();
        }
    } else if (e.code === 'ArrowLeft') {
        e.preventDefault();
        if (current > 0) {
            current--;
            playNext();
        }
    } else if (e.code === 'Enter' && e.ctrlKey) {
        // Leer el párrafo donde está el cursor
        e.preventDefault();
        const cursor = textInput.selectionStart;
        const text = textInput.value;
        
        // Si no se han establecido los párrafos, establecerlos
        if (textParts.length === 0) {
            textParts = getPartsFromText(text);
        }
        
        let paraIdx = 0;
        let position = 0;
        
        // Encuentra el párrafo que contiene la posición del cursor
        for (let i = 0; i < textParts.length; i++) {
            const partLength = textParts[i].length;
            const partPosition = text.indexOf(textParts[i], position);
            
            if (partPosition !== -1 && cursor >= partPosition && cursor <= partPosition + partLength) {
                paraIdx = i;
                break;
            }
            
            if (partPosition !== -1) {
                position = partPosition + partLength;
            }
        }
        
        jumpToPart(paraIdx);
    }
});

// Manejo del formulario para procesar el texto y comenzar la lectura
form.onsubmit = async (e) => {
    e.preventDefault();
    // Bloquea el textarea durante la reproducción
    textInput.readOnly = true;
    // Reinicia el estado
    cancelRequested = false;
    isPaused = false;
    pauseBtn.style.display = '';
    resumeBtn.style.display = 'none';
    audioContainer.innerHTML = '';
    clearHighlight();
    await fetch('/clear_cache', { method: 'POST' });
    const text = textInput.value.trim();
    if (!text) {
        showError('Por favor ingresa texto para leer');
        textInput.readOnly = false;
        return;
    }
    updateStatus('Procesando texto...');
    textParts = getPartsFromText(text);
    // Solicita las URLs de audio por partes
    let data;
    try {
        const res = await fetch('/tts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text })
        });
        data = await res.json();
    } catch (err) {
        showError('Error de conexión con el servidor.');
        updateStatus('Error de conexión.');
        textInput.readOnly = false;
        return;
    }
    if (!data.audio_urls || !data.audio_urls.length) {
        showError('No se pudo generar el audio.');
        updateStatus('No se pudo generar el audio.');
        textInput.readOnly = false;
        return;
    }
    current = 0;
    audios = data.audio_urls;
    audioElem = document.getElementById('mainAudio');
    if (!audioElem) {
        audioElem = document.createElement('audio');
        audioElem.id = 'mainAudio';
        audioElem.controls = true;
        audioElem.style.width = '100%';
        audioContainer.appendChild(audioElem);
    }
    async function waitForAudio(url) {
        updateStatus('Preparando audio...');
        for (let i = 0; i < 60; i++) {
            if (cancelRequested) return false;
            try {
                const resp = await fetch(url, { method: 'HEAD' });
                if (resp.ok) return true;
            } catch (error) {
                // sigue intentando
            }
            await new Promise(r => setTimeout(r, 500));
        }
        return false;
    }
    async function playNext() {
        if (cancelRequested) return;
        if (current < audios.length && current < textParts.length) {
            highlightParagraph(current);
            updateStatus(`Cargando parte ${current + 1} de ${textParts.length}...`);
            const url = audios[current];
            const ready = await waitForAudio(url);
            if (ready) {
                audioElem.src = url;
                audioElem.play();
                updateStatus(`Reproduciendo parte ${current + 1} de ${textParts.length}`);
            } else {
                updateStatus(`Error al cargar la parte ${current + 1}`);
                audioContainer.insertAdjacentHTML('beforeend', `<div class='text-danger mb-2'>No se pudo cargar el audio para la parte ${current + 1}.</div>`);
            }
        } else if (current >= audios.length) {
            clearHighlight();
            updateStatus('Reproducción completada');
            textInput.readOnly = false;
        }
    }
    audioElem.onended = async () => {
        if (isPaused) return;
        if (current < audios.length) {
            await fetch('/delete_audio', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: audios[current] })
            });
        }
        current++;
        playNext();
    };
    // Manejadores para los nuevos botones Anterior/Siguiente
    prevBtn.onclick = () => {
        if (current > 0) {
            current--;
            if (audioElem) audioElem.pause();
            playNext();
        }
    };
    nextBtn.onclick = () => {
        if (current < audios.length - 1) {
            current++;
            if (audioElem) audioElem.pause();
            playNext();
        }
    };
    playNext();
};

// Manejo de PDF
const pdfInput = document.getElementById('pdfInput');
const pdfStatus = document.getElementById('pdfStatus');

pdfInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    pdfStatus.textContent = 'Analizando PDF...';
    updateStatus('Procesando archivo PDF...');
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        const res = await fetch('/upload_pdf', {
            method: 'POST',
            body: formData
        });
        
        const data = await res.json();
        
        if (data.text) {
            textInput.value = data.text;
            pdfStatus.textContent = 'PDF cargado con éxito';
            updateStatus('PDF cargado. Listo para reproducir.');
        } else {
            pdfStatus.textContent = 'No se pudo leer el PDF.';
            updateStatus('Error al procesar el PDF');
            showError('No se pudo extraer el texto del PDF.');
        }
    } catch (error) {
        pdfStatus.textContent = 'Error al procesar el PDF.';
        updateStatus('Error al procesar el PDF');
        showError('Error al procesar el archivo PDF.');
        console.error(error);
    }
};
</script>
</body>
</html>
